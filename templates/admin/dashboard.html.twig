{% extends '@EasyAdmin/page/content.html.twig' %}

{% block page_title %}Dashboard
{% endblock %}
{% block content_title %}Dashboard
{% endblock %}

{% block head_stylesheets %}
	{{ parent() }}
	<link rel="stylesheet" href="{{ asset('assets/css/admin-dashboard.css') }}">
{% endblock %}

{% block body_javascript %}
	{{ parent() }}
	{# <script src="{{ asset('assets/js/admin-dashboard.js') }}"></script> #}
{% endblock %}

{% block main %}
	{# ===================== KPI ===================== #}
	<div class="kpi container-fluid px-0 mb-4">
		<div class="row row-cols-1 row-cols-sm-2 row-cols-lg-5 g-3">

			<div class="col">
				<div class="card h-100 shadow-sm">
					<div class="card-body text-center">
						<div class="label">Produits</div>
						<div class="value">{{ countProducts }}</div>
					</div>
				</div>
			</div>

			<div class="col">
				<div class="card h-100 shadow-sm">
					<div class="card-body text-center">
						<div class="label">Lignes de stock</div>
						<div class="value">{{ countStocks }}</div>
					</div>
				</div>
			</div>

			<div class="col">
				<div class="card h-100 shadow-sm card-alert">
					<div class="card-body text-center">
						<div class="label">⚠️ Stock bas (≤
							{{ threshold }})</div>
						<div class="value">{{ countLowStock }}</div>
					</div>
				</div>
			</div>

		</div>
	</div>

	{# ===================== LOW STOCK SECTION ===================== #}
	<section class="mt-4">
		<div class="d-flex align-items-center justify-content-between low-stock-header mb-3">
			<div class="d-flex align-items-center gap-2">
				<h5 class="mb-0">Produits en stock bas</h5>

				<span class="chip">
					<i class="fa fa-gauge-high"></i>
					seuil
					{{ threshold }}
				</span>

				<span class="chip">
					<i class="fa fa-bell"></i>
					{{ countLowStock }}
					alerte{{ countLowStock > 1 ? 's' : '' }}
				</span>
			</div>

			<div class="d-flex gap-2">
				<a href="{{ path('admin') }}" class="btn btn-sm btn-outline-light">
					<i class="fa fa-rotate-right me-1"></i>Rafraîchir
				</a>
				<button class="btn btn-sm btn-outline-secondary" disabled>
					<i class="fa fa-download me-1"></i>Exporter
				</button>
			</div>
		</div>

		{% if countLowStock > 0 %}
			<div class="row g-3 row-cols-1 row-cols-md-2 row-cols-xl-3 mb-3">

				{% for s in lowStocks %}
					{% set q = s.quantity + 0 %}
					{% set p = (q / (threshold ?: 1) * 100) | round(0, 'floor') %}
					{% set cls = q <= 0 ? 'crit' : (q < threshold/2 ? 'crit' : (q < threshold ? 'warn' : 'ok')) %}

					<div class="col">
						<div class="low-card h-100 p-3">
							<div class="d-flex justify-content-between align-items-start mb-2">
								<div>
									<div class="fw-semibold">{{ s.article.label }}</div>
									<div class="low-meta">
										{{ s.conditionnement.label ?? '—' }}
										·
										{{ s.magasin.name }}
									</div>
								</div>

								<div class="text-end">
									<div class="low-qty fw-bold {{ cls == 'crit' ? 'text-danger' : (cls == 'warn' ? 'text-warning' : 'text-success') }}">
										{{ q }}
									</div>
									<div class="muted" style="font-size:.8rem">Qté restante</div>
								</div>
							</div>

							<div class="progress mb-2" role="progressbar" aria-label="Niveau stock" aria-valuenow="{{ max(0, min(p, 100)) }}" aria-valuemin="0" aria-valuemax="100">
								<div class="progress-bar {{ cls }}" style="width: {{ max(0, min(p, 100)) }}%"></div>
							</div>

							<div class="d-flex justify-content-between muted" style="font-size:.8rem">
								<span>Seuil&nbsp;:
									{{ threshold }}</span>
								<span>{{ p }}%</span>
							</div>
						</div>
					</div>
				{% endfor %}

			</div>

			<div class="table-responsive">
				<table class="table table-sm table-striped align-middle">
					<thead class="table-light">
						<tr>
							<th>Produit</th>
							<th>Cond.</th>
							<th>Magasin</th>
							<th class="text-end">Qté</th>
						</tr>
					</thead>
					<tbody>
						{% for s in lowStocks %}
							<tr>
								<td class="fw-semibold">{{ s.article.label }}</td>
								<td>{{ s.conditionnement.label ?? '-' }}</td>
								<td>{{ s.magasin.name }}</td>
								<td class="text-end text-danger fw-bold">{{ s.quantity }}</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		{% else %}
			<div class="row mt-4">
				<div class="col-12 col-md-8 col-lg-6 mx-auto">
					<div class="empty text-center">
						<div class="icon">
							<i class="fa fa-circle-check"></i>
						</div>
						<h5 class="mb-1">Tout est au vert</h5>
						<p class="mb-0 muted">
							Aucun produit n’est en dessous du seuil critique pour le moment.
						</p>
					</div>
				</div>
			</div>
		{% endif %}
	</section>
{% endblock %}
