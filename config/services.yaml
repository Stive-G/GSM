parameters:
    # mongodb_db: '%env(MONGODB_DB)%'
    public_upload_dir: "%kernel.project_dir%/public/uploads"
    mongo_db_name: "gsm"
    mongo_products_collection: "products"

services:
    _defaults:
        autowire: true
        autoconfigure: true

    # ------------------------------------------------------
    # 1) Tous les services App\ sont autowirés automatiquement
    # ------------------------------------------------------
    App\:
        resource: "../src/"
        exclude:
            - "../src/DependencyInjection/"
            - "../src/Entity/"
            - "../src/Kernel.php"

    # ------------------------------------------------------
    # 2) CLIENT MONGODB (driver officiel mongodb/mongodb)
    # ------------------------------------------------------
    MongoDB\Client:
        class: MongoDB\Client
        arguments:
            - "%env(MONGODB_URI)%"

    # ------------------------------------------------------
    # 3) DATABASE Mongo à partir du client
    # ------------------------------------------------------
    MongoDB\Database:
        factory: ['@MongoDB\Client', "selectDatabase"]
        arguments:
            - "%env(MONGODB_DB)%"

    # ------------------------------------------------------
    # 4) MongoCatalogClient (service principal catalogue)
    #    → indispensable car il attend (Client $client, string $dbName)
    # ------------------------------------------------------
    App\Infrastructure\Mongo\MongoCatalogClient:
        arguments:
            $client: '@MongoDB\Client'
            $dbName: "%env(MONGODB_DB)%"

    App\Service\Media\ProductImageStorage:
        arguments:
            $publicUploadDir: "%public_upload_dir%"

    App\Service\ProductRefSyncService:
        arguments:
            $mongoDbName: "%mongo_db_name%"
            $mongoCollection: "%mongo_products_collection%"
